version: '3'

# Gestion des erreurs : arrÃªt immÃ©diat si une commande Ã©choue (errexit) et propagation des erreurs dans les pipes (pipefail)
set: [errexit, pipefail]

vars:
  # Changer Ã  ">/dev/null 2>&1" pour masquer toutes les sorties
  QUIET: ""
  # Chemin absolu vers Homebrew (utilisÃ© lors du bootstrap avant que PATH soit configurÃ©)
  BREW: /home/linuxbrew/.linuxbrew/bin/brew
  # Chemin absolu vers SOPS (utilisÃ© lors du bootstrap avant que PATH soit configurÃ©)
  SOPS: /home/linuxbrew/.linuxbrew/bin/sops
  
  # Liste des packages Homebrew Ã  installer (source unique de vÃ©ritÃ©)
  BREW_PACKAGES:
    - age
    # - ansible
    - argocd
    # - argocd-autopilot
    # - asciinema
    # - awscli
    - bat
    # - btop
    # - cilium-cli
    - cloud-provider-kind
    # - crossplane
    # - curl
    # - docker
    - eza
    - fastfetch
    # - fd
    - fzf
    # - git
    - helm
    # - k9s
    # - keychain
    - kind
    # - kube-linter
    # - kube-score
    - kubecolor
    # - kubectl
    # - kubescape
    - kubectx
    # - krew
    # - kustomize
    # - kyverno
    # - neovim
    # - opentofu
    - ripgrep
    - sops
    # - systemd
    # - velero
    - vim
    - wget
    - yq
    - zellij
    - zinit
    - zsh

tasks:
  # ==========================================
  # Point d'entrÃ©e principal
  # ==========================================
  
  default:
    desc: "Bootstrap complet de l'environnement"
    cmds:
      - task: bootstrap

  bootstrap:
    desc: "Installation et configuration complÃ¨te"
    # Les aliases permettent d'appeler cette tÃ¢che avec diffÃ©rents noms
    # Exemple: task bootstrap, task setup ou task init font la mÃªme chose
    aliases: [setup, init]
    output:
      group:
        begin: 'ğŸš€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        end: 'âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    cmds:
      - task: sudo:main
      - task: age:main
      - task: locales:main
      - task: brew:main
      - task: sops:main
      - task: git:main
      - task: zsh:main
      # - task: vscode:main
      # - task: wsl:main
      - task: status
      - cmd: echo "âœ… Bootstrap terminÃ© !"
        silent: true

  # ==========================================
  # Sudo
  # ==========================================

  sudo:main:
    desc: "Authentification sudo pour le bootstrap"
    cmds:
      - sudo -v
      - cmd: echo "âœ… Authentification validÃ©e"
        silent: true

  # ==========================================
  # Age
  # ==========================================

  age:main:
    desc: "DÃ©crypter la clÃ© age"
    cmds:
      - task: age:decrypt:key

  age:decrypt:key:
    desc: "DÃ©crypter la clÃ© age avec passphrase"
    cmds:
      - cmd: echo "ğŸ” DÃ©cryptage de la clÃ© age..."
        silent: true
      - mkdir -p ~/.config/sops/age
      - age --decrypt --output ~/.config/sops/age/keys.txt secrets/age-key.txt.age
      - chmod 600 ~/.config/sops/age/keys.txt
      - cmd: echo "âœ… ClÃ© age dÃ©cryptÃ©e"
        silent: true
      - defer: echo "ğŸ”’ ClÃ© age supprimÃ©e"
      - defer: rm -f ~/.config/sops/age/keys.txt
    status:
      - test -f ~/.config/sops/age/keys.txt

  # ==========================================
  # Locales
  # ==========================================

  locales:main:
    desc: "Configuration complÃ¨te des locales"
    run: once
    cmds:
      - task: locales:install:package
      - task: locales:generate

  locales:install:package:
    desc: "Installer le package locales"
    cmds:
      - sudo apt-get update {{.QUIET}}
      - sudo apt-get install -y locales {{.QUIET}}
      - sudo rm -rf /var/lib/apt/lists/*
      - cmd: echo "âœ… Package locales installÃ©"
        silent: true
    status:
      - dpkg -s locales >/dev/null 2>&1

  locales:generate:
    desc: "GÃ©nÃ©rer la locale en_US.UTF-8"
    cmds:
      - sudo localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 {{.QUIET}}
      - cmd: echo "âœ… Locale gÃ©nÃ©rÃ©e"
        silent: true
    status:
      - locale -a | grep -q "en_US.utf8"

  # ==========================================
  # Homebrew
  # ==========================================

  brew:main:
    desc: "Installation complÃ¨te de Homebrew et packages"
    run: once
    cmds:
      - task: brew:install:deps
      - task: brew:install:binary
      - task: brew:configure:path
      - task: brew:analytics:off
      - task: brew:install:packages
      - task: brew:verify:packages

  brew:install:deps:
    desc: "Installer les dÃ©pendances systÃ¨me requises"
    cmds:
      - sudo apt-get update {{.QUIET}}
      - sudo apt-get install -y build-essential procps curl file git wget {{.QUIET}}
      - cmd: echo "âœ… DÃ©pendances systÃ¨me installÃ©es"
        silent: true
    status:
      - dpkg -s build-essential >/dev/null 2>&1

  brew:install:binary:
    desc: "Installer le binaire Homebrew"
    cmds:
      - NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" {{.QUIET}}
      - cmd: echo "âœ… Homebrew installÃ© avec succÃ¨s"
        silent: true
    status:
      - command -v brew

  brew:configure:path:
    desc: "Configurer le PATH pour Homebrew"
    cmds:
      - echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
      - eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
      - cmd: echo "âœ… PATH configurÃ©"
        silent: true
    status:
      - grep -q "brew shellenv" ~/.bashrc

  brew:analytics:off:
    desc: "DÃ©sactiver la tÃ©lÃ©mÃ©trie Homebrew"
    cmds:
      - '{{.BREW}} analytics off {{.QUIET}}'
      - cmd: echo "âœ… TÃ©lÃ©mÃ©trie Homebrew dÃ©sactivÃ©e"
        silent: true
    status:
      - test "$({{.BREW}} analytics state)" = "Analytics are disabled."

  brew:install:packages:
    desc: "Installer les packages Homebrew essentiels"
    output: prefixed
    requires:
      vars: [BREW, BREW_PACKAGES]
    preconditions:
      - sh: command -v {{.BREW}} >/dev/null 2>&1
        msg: "âŒ Homebrew n'est pas installÃ©. ExÃ©cutez 'task brew:main' d'abord."
    cmds:
      - '{{.BREW}} install {{.BREW_PACKAGES | join " "}} {{.QUIET}}'
      - cmd: echo "âœ… Tous les packages sont installÃ©s"
        silent: true

  brew:verify:packages:
    desc: "VÃ©rifier les installations des packages"
    output: prefixed
    cmds:
      - cmd: echo "ğŸ” VÃ©rification des installations..."
        silent: true
      - |
        {{range .BREW_PACKAGES}}
        if command -v {{.}} >/dev/null 2>&1; then
          echo "âœ… {{.}}"
        else
          echo "âŒ {{.}} manquant"
        fi
        {{end}}
      - cmd: echo "âœ… VÃ©rification des packages terminÃ©e"
        silent: true

  # ==========================================
  # Homebrew - Tasks standalone (maintenance)
  # ==========================================

  brew:refresh:
    desc: "Maintenance complÃ¨te Homebrew (update + upgrade + cleanup)"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - task: brew:update
      - task: brew:upgrade
      - task: brew:cleanup
      - cmd: echo "âœ… Maintenance Homebrew terminÃ©e"
        silent: true

  brew:update:
    desc: "Mettre Ã  jour les dÃ©pÃ´ts Homebrew"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - brew update {{.QUIET}}
      - cmd: echo "âœ… DÃ©pÃ´ts Homebrew mis Ã  jour"
        silent: true

  brew:upgrade:
    desc: "Upgrader tous les packages Homebrew"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - brew upgrade {{.QUIET}}
      - cmd: echo "âœ… Packages Homebrew upgradÃ©s"
        silent: true

  brew:cleanup:
    desc: "Nettoyer les anciennes versions de packages"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - brew cleanup {{.QUIET}}
      - cmd: echo "âœ… Nettoyage terminÃ©"
        silent: true

  brew:list:
    desc: "Lister tous les packages installÃ©s avec leurs versions"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - cmd: echo "ğŸ“‹ Packages Homebrew installÃ©s :"
        silent: true
      - brew list --versions

  brew:leaves:
    desc: "Lister les packages installÃ©s manuellement avec versions"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - cmd: echo "ğŸƒ Packages installÃ©s manuellement :"
        silent: true
      - brew leaves | xargs brew list --versions

  # ==========================================
  # SOPS
  # ==========================================

  sops:main:
    desc: "DÃ©ployer les secrets SOPS"
    cmds:
      - task: sops:deploy:ssh

  sops:deploy:ssh:
    desc: "DÃ©ployer les clÃ©s SSH depuis SOPS"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    requires:
      vars: [SOPS]
    preconditions:
      - sh: command -v {{.SOPS}} >/dev/null 2>&1
        msg: "âŒ SOPS n'est pas installÃ©. ExÃ©cutez 'task brew:main' d'abord."
      - sh: test -f ~/.config/sops/age/keys.txt
        msg: "âŒ ClÃ© age non disponible. ExÃ©cutez 'task age:main' d'abord."
      - sh: test -f secrets/ssh-keys.sops.yaml
        msg: "âŒ Fichier secrets/ssh-keys.sops.yaml introuvable."
    cmds:
      - cmd: echo "ğŸ”‘ DÃ©ploiement des clÃ©s SSH..."
        silent: true
      - mkdir -p ~/.ssh
      - chmod 700 ~/.ssh
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["gitlab"]["private_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/gitlab'
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["gitlab"]["public_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/gitlab.pub'
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["seedbox"]["private_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/seedbox'
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["seedbox"]["public_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/seedbox.pub'
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["github"]["private_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/github'
      - '{{.SOPS}} --decrypt --extract ''["ssh"]["github"]["public_key"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/github.pub'
      - '{{.SOPS}} --decrypt --extract ''["ssh_config"]'' secrets/ssh-keys.sops.yaml > ~/.ssh/config'
      - chmod 600 ~/.ssh/gitlab ~/.ssh/seedbox ~/.ssh/github ~/.ssh/config
      - chmod 644 ~/.ssh/gitlab.pub ~/.ssh/seedbox.pub ~/.ssh/github.pub
      - cmd: echo "âœ… ClÃ©s SSH dÃ©ployÃ©es"
        silent: true

  # ==========================================
  # Git
  # ==========================================

  git:main:
    desc: "Configuration complÃ¨te de Git"
    run: once
    cmds:
      - task: git:configure:user

  git:configure:user:
    desc: "Configurer l'utilisateur Git global"
    cmds:
      - git config --global user.email "felix.mathias95@gmail.com"
      - git config --global user.name "Mathod"
      - cmd: echo "âœ… Utilisateur Git configurÃ©"
        silent: true
    status:
      - test "$(git config --global user.email)" = "felix.mathias95@gmail.com"
      - test "$(git config --global user.name)" = "Mathod"

  # ==========================================
  # SSH
  # ==========================================

  # ssh:configure:agent:
  #   desc: "Configurer le dÃ©marrage automatique de l'agent SSH"
  #   cmds:
  #     - cmd: echo "ğŸ”§ Configuration de l'agent SSH..."
  #       silent: true
  #     - bash -c 'cat >> ~/.bashrc << "EOF"

  # # Agent SSH - DÃ©marrage automatique
  # if [ -z "$SSH_AUTH_SOCK" ]; then
  #   eval $(ssh-agent -s) > /dev/null
  # fi
  # EOF'
  #     - cmd: echo "âœ… Agent SSH configurÃ© (dÃ©marrage automatique)"
  #       silent: true
  #   status:
  #     - grep -q "Agent SSH - DÃ©marrage automatique" ~/.bashrc

  ssh:add:keys:
    desc: "Ajouter les clÃ©s SSH Ã  l'agent (demande passphrases)"
    cmds:
      - cmd: echo "ğŸ”‘ Ajout des clÃ©s SSH Ã  l'agent..."
        silent: true
      - ssh-add ~/.ssh/github
      - ssh-add ~/.ssh/gitlab
      - ssh-add ~/.ssh/seedbox
      - cmd: echo "âœ… ClÃ©s SSH ajoutÃ©es Ã  l'agent"
        silent: true

  # ==========================================
  # Zsh
  # ==========================================

  zsh:main:
    desc: "Configuration complÃ¨te de Zsh"
    run: once
    cmds:
      - task: zsh:configure:histfile
      - task: zsh:configure:add-to-shells
      - task: zsh:configure:default-shell
      - task: zsh:deploy:config
      # - task: zsh:plugins:install

  zsh:configure:histfile:
    desc: "CrÃ©er le fichier d'historique Zsh"
    cmds:
      - touch ~/.histfile
      - chmod 600 ~/.histfile
      - cmd: echo "âœ… Fichier d'historique Zsh crÃ©Ã©"
        silent: true
    status:
      - test -f ~/.histfile

  zsh:configure:add-to-shells:
    desc: "Ajouter Zsh Ã  la liste des shells valides"
    cmds:
      - echo "/home/linuxbrew/.linuxbrew/bin/zsh" | sudo tee -a /etc/shells {{.QUIET}}
      - cmd: echo "âœ… Zsh ajoutÃ© Ã  /etc/shells"
        silent: true
    status:
      - grep -q "^/home/linuxbrew/.linuxbrew/bin/zsh$" /etc/shells

  zsh:configure:default-shell:
    desc: "DÃ©finir Zsh comme shell par dÃ©faut"
    cmds:
      - sudo chsh -s /home/linuxbrew/.linuxbrew/bin/zsh "$USER"
      - cmd: echo "âœ… Zsh dÃ©fini comme shell par dÃ©faut"
        silent: true
      - cmd: echo ""
        silent: true
      - cmd: echo "âš ï¸  IMPORTANT - RedÃ©marrer le terminal pour appliquer !"
        silent: true
    status:
      - grep -q "^$USER.*:/home/linuxbrew/.linuxbrew/bin/zsh$" /etc/passwd

  zsh:deploy:config:
    desc: "DÃ©ployer la configuration Zsh"
    preconditions:
      - sh: test -f configs/.zshrc
        msg: "âŒ Fichier configs/.zshrc introuvable."
    cmds:
      - cp configs/.zshrc ~/.zshrc
      - cmd: echo "âœ… .zshrc dÃ©ployÃ©"
        silent: true

  # zsh:plugins:install:
  #   desc: "Installer les plugins Zsh avec zinit"
  #   cmds:
  #     - cmd: echo "ğŸ“¦ Installation des plugins Zsh..."
  #       silent: true
  #     - /home/linuxbrew/.linuxbrew/bin/zsh -c "source ~/.zshrc; exit" {{.QUIET}} &
  #     - cmd: echo "âœ… Plugins Zsh en cours d'installation (arriÃ¨re-plan)"
  #       silent: true

  # ==========================================
  # VS Code (COMMENTED)
  # ==========================================

  # vscode:main:
  #   desc: "Configuration de VS Code pour WSL"
  #   cmds:
  #     - task: vscode:configure:symlink
  #     - task: vscode:install:server
  #     - task: vscode:extensions:symlinks
  #     - task: vscode:extensions:install

  vscode:configure:symlink:
    desc: "CrÃ©er le symlink vers VS Code Windows"
    cmds:
      - sudo ln -s "/mnt/c/Users/Mathod/AppData/Local/Programs/Microsoft VS Code/bin/code" /usr/local/bin/code
      - cmd: echo "âœ… Symlink VS Code crÃ©Ã©"
        silent: true
    status:
      - test -L /usr/local/bin/code

  vscode:install:server:
    desc: "Installer VS Code Server dans WSL"
    env:
      PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
    cmds:
      - cmd: echo "ğŸ“¦ Installation de VS Code Server..."
        silent: true
      - /usr/local/bin/code --version {{.QUIET}}
      - cmd: echo "âœ… VS Code Server installÃ©"
        silent: true
    status:
      - test -d ~/.vscode-server

  # vscode:extensions:symlinks:
  #   desc: "CrÃ©er les symlinks helm/kubectl pour VS Code Kubernetes"
  #   cmds:
  #     - mkdir -p ~/.local/state/vs-kubernetes/tools/helm/linux-amd64
  #     - mkdir -p ~/.local/state/vs-kubernetes/tools/kubectl
  #     - ln -sf /home/linuxbrew/.linuxbrew/bin/helm ~/.local/state/vs-kubernetes/tools/helm/linux-amd64/helm
  #     - ln -sf /home/linuxbrew/.linuxbrew/bin/kubectl ~/.local/state/vs-kubernetes/tools/kubectl/kubectl
  #     - cmd: echo "âœ… Symlinks helm/kubectl crÃ©Ã©s"
  #       silent: true

  # vscode:extensions:install:
  #   desc: "Installer les extensions VS Code"
  #   env:
  #     PATH: /home/linuxbrew/.linuxbrew/bin:{{.PATH}}
  #   vars:
  #     EXTENSIONS:
  #       - ms-kubernetes-tools.vscode-kubernetes-tools
  #       - ms-kubernetes-tools.kind-vscode
  #       - ms-azuretools.vscode-docker
  #       - task.vscode-task
  #       - upboundio.upbound
  #       - redhat.vscode-yaml
  #   cmds:
  #     - '/usr/local/bin/code --install-extension {{.EXTENSIONS | join " --install-extension "}} {{.QUIET}}'
  #     - cmd: echo "âœ… Extensions VS Code installÃ©es"
  #       silent: true

  # ==========================================
  # WSL (COMMENTED)
  # ==========================================

  # wsl:main:
  #   desc: "Configuration de WSL"
  #   cmds:
  #     - task: wsl:configure:systemd

  # wsl:configure:systemd:
  #   desc: "Activer systemd dans WSL"
  #   cmds:
  #     - sudo ln -sf /home/linuxbrew/.linuxbrew/opt/systemd/lib/systemd/systemd /sbin/init
  #     - sudo bash -c 'grep -q "^\[boot\]" /etc/wsl.conf 2>/dev/null || printf "\n[boot]\n" >> /etc/wsl.conf'
  #     - sudo bash -c 'grep -q "^systemd.*=.*true" /etc/wsl.conf 2>/dev/null || sed -i "/^\[boot\]/a systemd = true" /etc/wsl.conf'
  #     - cmd: echo "âœ… systemd activÃ© - RedÃ©marrer WSL avec 'wsl --shutdown' dans PowerShell"
  #       silent: true
  #   status:
  #     - test -L /sbin/init
  #     - grep -q "^\[boot\]" /etc/wsl.conf
  #     - grep -q "^systemd.*=.*true" /etc/wsl.conf

  # ==========================================
  # Status
  # ==========================================

  status:
    desc: "ğŸ“Š Affiche le statut de l'environnement"
    cmds:
      - echo "ğŸ“Š Statut de l'environnement"
      - echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      - echo ""
      - task: status:check:brew
      - task: status:check:zsh
      - task: status:check:git
      - task: status:check:secrets
      - task: status:check:ssh
      - task: status:check:packages
      - echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

  status:check:brew:
    internal: true
    cmds:
      - echo "ğŸº Homebrew :"
      - cmd: if command -v brew >/dev/null 2>&1; then echo "  âœ… InstallÃ© ($({{.BREW}} --version | head -1))"; else echo "  âŒ Non installÃ©"; fi
      - echo ""

  status:check:zsh:
    internal: true
    cmds:
      - echo "ğŸš Zsh :"
      - cmd: if command -v zsh >/dev/null 2>&1; then echo "  âœ… InstallÃ© ($(zsh --version))"; else echo "  âŒ Non installÃ©"; fi
      - echo ""

  status:check:git:
    internal: true
    cmds:
      - echo "ğŸ”§ Git :"
      - cmd: if command -v git >/dev/null 2>&1; then echo "  âœ… InstallÃ©"; echo "  ğŸ‘¤ Nom{{":"}} $(git config --global user.name 2>/dev/null || echo 'non configurÃ©')"; echo "  ğŸ“§ Email{{":"}} $(git config --global user.email 2>/dev/null || echo 'non configurÃ©')"; else echo "  âŒ Non installÃ©"; fi
      - echo ""

  status:check:secrets:
    internal: true
    cmds:
      - echo "ğŸ” Secrets :"
      - cmd: if [ -f ~/.config/sops/age/keys.txt ]; then echo "  ğŸ”“ DÃ©verrouillÃ©s"; else echo "  ğŸ”’ VerrouillÃ©s"; fi
      - echo ""

  status:check:ssh:
    internal: true
    cmds:
      - echo "ğŸ”‘ SSH :"
      - cmd: test -f ~/.ssh/config && echo "  âœ… Config SSH prÃ©sent" || echo "  âŒ Config SSH manquant"
      - cmd: test -f ~/.ssh/github && echo "  âœ… ClÃ© GitHub prÃ©sente" || echo "  âŒ ClÃ© GitHub manquante"
      - cmd: test -f ~/.ssh/gitlab && echo "  âœ… ClÃ© GitLab prÃ©sente" || echo "  âŒ ClÃ© GitLab manquante"
      - cmd: test -f ~/.ssh/seedbox && echo "  âœ… ClÃ© Seedbox prÃ©sente" || echo "  âŒ ClÃ© Seedbox manquante"
      - echo ""

  status:check:packages:
    internal: true
    cmds:
      - echo "ğŸ“¦ Packages Homebrew :"
      - cmd: if command -v brew >/dev/null 2>&1; then echo "  ğŸ“¦ $({{.BREW}} list 2>/dev/null | wc -l) packages installÃ©s"; else echo "  âŒ Homebrew non installÃ©"; fi
      - echo ""

  # ==========================================
  # Aide
  # ==========================================

  help:
    desc: "Afficher l'aide des commandes disponibles"
    silent: true
    cmds:
      - echo "ğŸš€ Taskfile Bootstrap - Commandes disponibles"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸ¯ PRINCIPALES"
      - echo "  task                                    Bootstrap complet"
      - echo "  task bootstrap                          Installation et configuration complÃ¨te"
      - echo "  task help                               Afficher cette aide"
      - echo ""
      - echo "ğŸ” SUDO"
      - echo "  task sudo:main                          Authentification sudo"
      - echo ""
      - echo "ğŸ”‘ AGE"
      - echo "  task age:main                           DÃ©crypter la clÃ© age"
      - echo "  task age:decrypt:key                    DÃ©crypter la clÃ© age avec passphrase"
      - echo ""
      - echo "ğŸŒ LOCALES"
      - echo "  task locales:main                       Configuration complÃ¨te des locales"
      - echo "  task locales:install:package            Installer le package locales"
      - echo "  task locales:generate                   GÃ©nÃ©rer la locale en_US.UTF-8"
      - echo ""
      - echo "ğŸº HOMEBREW - INSTALLATION"
      - echo "  task brew:main                          Installation complÃ¨te de Homebrew"
      - echo "  task brew:install:deps                  Installer les dÃ©pendances systÃ¨me"
      - echo "  task brew:install:binary                Installer le binaire Homebrew"
      - echo "  task brew:configure:path                Configurer le PATH pour Homebrew"
      - echo "  task brew:analytics:off                 DÃ©sactiver la tÃ©lÃ©mÃ©trie Homebrew"
      - echo "  task brew:install:packages              Installer les packages essentiels"
      - echo "  task brew:verify:packages               VÃ©rifier les installations des packages"
      - echo ""
      - echo "ğŸº HOMEBREW - MAINTENANCE"
      - echo "  task brew:refresh                       Maintenance complÃ¨te (update + upgrade + cleanup)"
      - echo "  task brew:update                        Mettre Ã  jour les dÃ©pÃ´ts"
      - echo "  task brew:upgrade                       Upgrader tous les packages"
      - echo "  task brew:cleanup                       Nettoyer les anciennes versions"
      - echo "  task brew:list                          Lister tous les packages"
      - echo "  task brew:leaves                        Lister les packages installÃ©s manuellement"
      - echo ""
      - echo "ğŸ” SOPS"
      - echo "  task sops:main                          DÃ©ployer les secrets SOPS"
      - echo "  task sops:deploy:ssh                    DÃ©ployer les clÃ©s SSH"
      - echo ""
      - echo "ğŸ”§ GIT"
      - echo "  task git:main                           Configuration complÃ¨te de Git"
      - echo "  task git:configure:user                 Configurer l'utilisateur Git global"
      - echo ""
      - echo "ğŸ”‘ SSH"
      - echo "  task ssh:add:keys                       Ajouter les clÃ©s SSH Ã  l'agent"
      - echo ""
      - echo "ğŸš ZSH"
      - echo "  task zsh:main                           Configuration complÃ¨te de Zsh"
      - echo "  task zsh:configure:histfile             CrÃ©er le fichier d'historique"
      - echo "  task zsh:configure:add-to-shells        Ajouter Zsh Ã  /etc/shells"
      - echo "  task zsh:configure:default-shell        DÃ©finir Zsh comme shell par dÃ©faut"
      - echo "  task zsh:deploy:config                  DÃ©ployer .zshrc"
      - echo ""
      - echo "ğŸ“Š STATUS"
      - echo "  task status                             Afficher le statut de l'environnement"
      - echo ""
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸ”§ VARIABLES DISPONIBLES"
      - echo "  QUIET={{.QUIET}}                        Masquer les sorties (vide par dÃ©faut)"
      - echo "  BREW={{.BREW}}                          Chemin vers Homebrew"
      - echo "  SOPS={{.SOPS}}                          Chemin vers SOPS"
      - echo "  BREW_PACKAGES                           Liste des packages Ã  installer ({{.BREW_PACKAGES | len}} packages)"
      - echo ""
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo "ğŸ’¡ Astuce - Lance 'task --list' pour voir toutes les commandes disponibles"