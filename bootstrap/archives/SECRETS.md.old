# ğŸ” Guide complet : Gestion sÃ©curisÃ©e des secrets avec age + SOPS

Ce guide explique comment gÃ©rer de maniÃ¨re sÃ©curisÃ©e tes clÃ©s SSH (et autres secrets) en utilisant **age** et **SOPS** pour les chiffrer avant de les commiter dans Git.

---

## ğŸ“‹ Table des matiÃ¨res

1. [Vue d'ensemble](#vue-densemble)
2. [PrÃ©requis](#prÃ©requis)
3. [Installation initiale (premiÃ¨re fois)](#installation-initiale-premiÃ¨re-fois)
4. [Chiffrer tes clÃ©s SSH](#chiffrer-tes-clÃ©s-ssh)
5. [Gestion de plusieurs clÃ©s SSH](#gestion-de-plusieurs-clÃ©s-ssh)
6. [DÃ©ploiement sur une nouvelle machine](#dÃ©ploiement-sur-une-nouvelle-machine)
7. [Commandes utiles](#commandes-utiles)
8. [SÃ©curitÃ© et bonnes pratiques](#sÃ©curitÃ©-et-bonnes-pratiques)
9. [DÃ©pannage](#dÃ©pannage)

---

## ğŸ¯ Vue d'ensemble

### Pourquoi age + SOPS ?

**Le problÃ¨me :**
- âŒ Les clÃ©s SSH ne doivent JAMAIS Ãªtre commitÃ©es en clair dans Git
- âŒ Mais on veut pouvoir les versionner et les partager entre machines

**La solution :**
- âœ… **age** : Outil moderne de chiffrement (remplace GPG)
- âœ… **SOPS** : Chiffre uniquement les valeurs dans les fichiers YAML/JSON
- âœ… Commit des fichiers chiffrÃ©s dans Git (sÃ©curisÃ©)
- âœ… DÃ©chiffrement automatique avec ta clÃ© age

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ton ordinateur                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ~/.ssh/gitlab               (EN CLAIR - ne pas commiter)   â”‚
â”‚ ~/.ssh/seedbox              (EN CLAIR - ne pas commiter)   â”‚
â”‚ ~/.ssh/config               (EN CLAIR - ne pas commiter)   â”‚
â”‚ ~/.config/sops/age/keys.txt (CLÃ‰E AGE - ne pas commiter)   â”‚
â”‚                                                             â”‚
â”‚ secrets/ssh-keys.sops.yaml  (CHIFFRÃ‰ - safe pour Git)      â”‚
â”‚   â”œâ”€ gitlab (chiffrÃ©e)                                      â”‚
â”‚   â”œâ”€ seedbox (chiffrÃ©e)                                     â”‚
â”‚   â””â”€ SSH config (chiffrÃ©)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ git push
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Git Repository (GitHub/GitLab)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… secrets/ssh-keys.sops.yaml  (chiffrÃ© - safe)            â”‚
â”‚ âœ… .sops.yaml                   (config)                    â”‚
â”‚ âŒ ~/.config/sops/age/keys.txt (JAMAIS dans Git !)         â”‚
â”‚ âŒ ~/.ssh/gitlab                (JAMAIS dans Git !)        â”‚
â”‚ âŒ ~/.ssh/seedbox               (JAMAIS dans Git !)        â”‚
â”‚ âŒ ~/.ssh/config                (JAMAIS dans Git !)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ PrÃ©requis

- Debian WSL2
- Homebrew installÃ©
- Tes clÃ©s SSH existantes dans `~/.ssh/`

---

## ğŸš€ Installation initiale (premiÃ¨re fois)

### Ã‰tape 1 : Installer age et SOPS

```bash
# Si Homebrew n'est pas installÃ©
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

# Installer age et SOPS
brew install age sops yq

# VÃ©rifier l'installation
age --version
sops --version
yq --version
```

### Ã‰tape 2 : GÃ©nÃ©rer ta clÃ© age

```bash
# CrÃ©er le rÃ©pertoire standard de SOPS
mkdir -p ~/.config/sops/age

# GÃ©nÃ©rer la clÃ© (directement au bon emplacement)
age-keygen -o ~/.config/sops/age/keys.txt

# SÃ©curiser les permissions
chmod 600 ~/.config/sops/age/keys.txt

# Afficher la clÃ©
cat ~/.config/sops/age/keys.txt
```

**âš ï¸ Important :** On utilise l'emplacement standard `~/.config/sops/age/keys.txt` car c'est lÃ  que SOPS cherche automatiquement la clÃ©. Aucune configuration supplÃ©mentaire n'est nÃ©cessaire !

**Tu verras :**
```
# created: 2025-12-17 10:30:00
# public key: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
AGE-SECRET-KEY-1XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

### âš ï¸ CRITIQUE : Sauvegarde ta clÃ© age MAINTENANT !

**Sans cette clÃ©, impossible de dÃ©chiffrer tes secrets !**

**Endroits sÃ»rs pour la sauvegarder :**
1. âœ… Password manager (1Password, Bitwarden, KeePass)
2. âœ… USB chiffrÃ©e (VeraCrypt, BitLocker)
3. âœ… Papier dans un coffre physique
4. âœ… Cloud personnel chiffrÃ© (Cryptomator + Dropbox)
5. âœ… Partition chiffrÃ©e sÃ©parÃ©e

**MÃ©thodes de sauvegarde :**

```bash
# Copier vers USB
cp ~/.config/sops/age/keys.txt /mnt/usb/sops-age-key-backup.txt

# Afficher pour copier dans password manager
cat ~/.config/sops/age/keys.txt

# CrÃ©er une sauvegarde locale
cp ~/.config/sops/age/keys.txt ~/Documents/backups/sops-age-key-$(date +%Y%m%d).txt
```

### Ã‰tape 3 : RÃ©cupÃ©rer ta clÃ© publique age

```bash
age-keygen -y ~/.config/sops/age/keys.txt
```

**Sortie :**
```
age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

ğŸ’¾ **Copie cette clÃ© publique** pour l'Ã©tape suivante.

### Ã‰tape 4 : Configurer SOPS

Dans le rÃ©pertoire de ton projet (oÃ¹ se trouve `Taskfile.yaml`) :

```bash
# CrÃ©er le fichier .sops.yaml
cat > .sops.yaml << EOF
creation_rules:
  - age: $(age-keygen -y ~/.config/sops/age/keys.txt)
EOF
```

**âš ï¸ La clÃ© publique sera automatiquement insÃ©rÃ©e dans le fichier.**

### Ã‰tape 5 : CrÃ©er le rÃ©pertoire secrets

```bash
mkdir -p secrets
```

---

## ğŸ”‘ Chiffrer tes clÃ©s SSH

### Une seule clÃ© SSH

Si tu as une seule clÃ© SSH (`~/.ssh/id_rsa`) :

```bash
# Depuis le rÃ©pertoire du projet
cd ~/mon-projet

mkdir -p secrets

# CrÃ©er le fichier YAML dans secrets/
cat > secrets/ssh-keys.yaml << 'EOF'
ssh:
  private_key: |
EOF

# Ajouter la clÃ© privÃ©e
cat ~/.ssh/id_rsa | sed 's/^/    /' >> secrets/ssh-keys.yaml

# Ajouter la clÃ© publique
echo "  public_key: $(cat ~/.ssh/id_rsa.pub)" >> secrets/ssh-keys.yaml

# Chiffrer le fichier
sops --encrypt secrets/ssh-keys.yaml > secrets/ssh-keys.sops.yaml

# Supprimer le fichier en clair
rm secrets/ssh-keys.yaml

echo "âœ… ClÃ© SSH chiffrÃ©e dans secrets/ssh-keys.sops.yaml"
```

### VÃ©rifier le chiffrement

```bash
# Voir le fichier chiffrÃ© (illisible)
cat secrets/ssh-keys.sops.yaml

# DÃ©chiffrer pour vÃ©rifier (lisible)
sops --decrypt secrets/ssh-keys.sops.yaml
```

**Le fichier chiffrÃ© ressemble Ã  Ã§a :**
```yaml
ssh:
    private_key: ENC[AES256_GCM,data:LS0tLS...,iv:xxx,tag:yyy,type:str]
    public_key: ENC[AES256_GCM,data:c3NoLX...,iv:xxx,tag:yyy,type:str]
sops:
    age:
        - recipient: age1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            ...
            -----END AGE ENCRYPTED FILE-----
```

---

## ğŸ” Gestion de plusieurs clÃ©s SSH

### Exemple avec les clÃ©s gitlab et seedbox

Si tu as plusieurs clÃ©s SSH (par exemple `gitlab` et `seedbox`) :

**CrÃ©er le fichier avec toutes les clÃ©s + SSH config :**

```bash
# Depuis le rÃ©pertoire du projet
cd ~/mon-projet

mkdir -p secrets

# CrÃ©er le fichier YAML complet
cat > secrets/ssh-keys.yaml << 'EOF'
ssh:
  gitlab:
    private_key: |
EOF

# Ajouter clÃ© GitLab
cat ~/.ssh/gitlab | sed 's/^/      /' >> secrets/ssh-keys.yaml
echo "    public_key: $(cat ~/.ssh/gitlab.pub)" >> secrets/ssh-keys.yaml

# Ajouter clÃ© Seedbox
cat >> secrets/ssh-keys.yaml << 'EOF'
  
  seedbox:
    private_key: |
EOF

cat ~/.ssh/seedbox | sed 's/^/      /' >> secrets/ssh-keys.yaml
echo "    public_key: $(cat ~/.ssh/seedbox.pub)" >> secrets/ssh-keys.yaml

# Ajouter le SSH config
cat >> secrets/ssh-keys.yaml << 'EOF'

ssh_config: |
EOF

cat ~/.ssh/config | sed 's/^/  /' >> secrets/ssh-keys.yaml

# Chiffrer avec SOPS
sops --encrypt secrets/ssh-keys.yaml > secrets/ssh-keys.sops.yaml

# Supprimer le fichier en clair
rm secrets/ssh-keys.yaml

echo "âœ… ClÃ©s gitlab + seedbox + config chiffrÃ©s"
```

**âš ï¸ Note importante :** Le fichier `~/.ssh/config` contient des informations sensibles et est maintenant **inclus dans le chiffrement SOPS**.

### Exemple de SSH config pour gitlab et seedbox

**Ton `~/.ssh/config` devrait ressembler Ã  Ã§a :**

```bash
# GitLab
Host gitlab.com
  HostName gitlab.com
  User git
  IdentityFile ~/.ssh/gitlab
  IdentitiesOnly yes

# Seedbox
Host seedbox
  HostName ton-seedbox.example.com
  User ton-user
  IdentityFile ~/.ssh/seedbox
  Port 22
  IdentitiesOnly yes

# Configuration par dÃ©faut
Host *
  AddKeysToAgent yes
  ServerAliveInterval 60
  ServerAliveCountMax 30
```

**âš ï¸ Adapte les valeurs :**
- `ton-seedbox.example.com` â†’ Adresse de ta seedbox
- `ton-user` â†’ Ton nom d'utilisateur sur la seedbox
- `Port 22` â†’ Le port SSH si diffÃ©rent
---

## ğŸ“¦ Commiter dans Git

### Configurer .gitignore

```bash
cat >> .gitignore << 'EOF'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Secrets - NE JAMAIS COMMITER EN CLAIR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ClÃ© age (CRITIQUE)
.config/sops/age/keys.txt

# ClÃ©s SSH en clair
gitlab
gitlab.pub
seedbox
seedbox.pub
id_rsa
id_ed25519
*.pem
*.key

# SSH config en clair
config

# Fichiers secrets en clair dans secrets/
secrets/*.yaml
secrets/*.yml
secrets/*.json

# Mais on garde les fichiers SOPS chiffrÃ©s (safe)
!secrets/*.sops.yaml
!.sops.yaml
EOF
```

### Commiter les secrets chiffrÃ©s

```bash
# Ajouter les fichiers chiffrÃ©s (safe !)
git add .sops.yaml
git add secrets/ssh-keys.sops.yaml
git add .gitignore

# Commit
git commit -m "Add encrypted SSH keys with SOPS + age"

# Push
git push
```

---

## ğŸŒ DÃ©ploiement sur une nouvelle machine

### Workflow complet

```bash
# 1. Clone le repo
git clone git@github.com:ton-user/ton-repo.git
cd ton-repo

# 2. Restaure ta clÃ© age (directement au bon emplacement)
mkdir -p ~/.config/sops/age

# Option A : Depuis USB
cp /mnt/usb/sops-age-key-backup.txt ~/.config/sops/age/keys.txt

# Option B : Depuis password manager (copie manuelle)
nano ~/.config/sops/age/keys.txt
# Colle ta clÃ© (AGE-SECRET-KEY-xxx...)
# Ctrl+X, Y, Enter

# Option C : Depuis un fichier de backup
cp ~/backups/sops-age-key.txt ~/.config/sops/age/keys.txt

chmod 600 ~/.config/sops/age/keys.txt

# 3. VÃ©rifie que la clÃ© fonctionne
sops --decrypt secrets/ssh-keys.sops.yaml

# 4. DÃ©chiffre les clÃ©s SSH ET le config
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Pour gitlab
sops --decrypt secrets/ssh-keys.sops.yaml | yq '.ssh.gitlab.private_key' > ~/.ssh/gitlab
sops --decrypt secrets/ssh-keys.sops.yaml | yq -r '.ssh.gitlab.public_key' > ~/.ssh/gitlab.pub
chmod 600 ~/.ssh/gitlab
chmod 644 ~/.ssh/gitlab.pub

# Pour seedbox
sops --decrypt secrets/ssh-keys.sops.yaml | yq '.ssh.seedbox.private_key' > ~/.ssh/seedbox
sops --decrypt secrets/ssh-keys.sops.yaml | yq -r '.ssh.seedbox.public_key' > ~/.ssh/seedbox.pub
chmod 600 ~/.ssh/seedbox
chmod 644 ~/.ssh/seedbox.pub

# DÃ©chiffrer le SSH config
sops --decrypt secrets/ssh-keys.sops.yaml | yq '.ssh_config' > ~/.ssh/config
chmod 600 ~/.ssh/config

# 5. Tester les connexions
ssh -T git@gitlab.com
ssh seedbox
```

### Avec Taskfile (automatisÃ©)

Si tu as intÃ©grÃ© les tÃ¢ches dans ton Taskfile :

```bash
# 1. Clone
git clone <repo>
cd <repo>

# 2. Restaure la clÃ© age
mkdir -p ~/.config/sops/age
cp /usb/sops-age-key.txt ~/.config/sops/age/keys.txt
chmod 600 ~/.config/sops/age/keys.txt

# 3. Bootstrap (tout est automatique)
task
```

---

## ğŸ’¡ Commandes utiles

### Ã‰diter les secrets

```bash
# Ã‰dite directement (SOPS dÃ©chiffre, tu modifies, il rechiffre)
sops secrets/ssh-keys.sops.yaml
```

### Voir les secrets

```bash
# Affiche le contenu dÃ©chiffrÃ©
sops --decrypt secrets/ssh-keys.sops.yaml

# Affiche juste une clÃ© spÃ©cifique
sops --decrypt secrets/ssh-keys.sops.yaml | yq '.ssh.github.public_key'
```

### Lister les clÃ©s disponibles

```bash
# Liste toutes les clÃ©s dans le fichier
sops --decrypt secrets/ssh-keys.sops.yaml | yq -r '.ssh | keys[]'
```

### Ajouter une nouvelle clÃ©

```bash
# 1. Ã‰dite le fichier
sops secrets/ssh-keys.sops.yaml

# 2. Ajoute ta nouvelle clÃ© dans l'Ã©diteur :
#   new-server:
#     private_key: |
#       -----BEGIN OPENSSH PRIVATE KEY-----
#       ...
#       -----END OPENSSH PRIVATE KEY-----
#     public_key: ssh-ed25519 AAAA... user@host

# 3. Sauvegarde (SOPS rechiffre automatiquement)

# 4. Commit
git add secrets/ssh-keys.sops.yaml
git commit -m "Add new-server SSH key"
git push
```

### Rotation de la clÃ© age

Si tu veux changer ta clÃ© age :

```bash
# 1. GÃ©nÃ¨re une nouvelle clÃ©
age-keygen -o ~/.age/new-key.txt

# 2. RÃ©cupÃ¨re la nouvelle clÃ© publique
age-keygen -y ~/.age/new-key.txt

# 3. Met Ã  jour .sops.yaml avec la nouvelle clÃ© publique

# 4. Rechiffre tous les secrets
sops updatekeys secrets/ssh-keys.sops.yaml

# 5. Remplace l'ancienne clÃ©
mv ~/.age/new-key.txt ~/.age/key.txt

# 6. Commit
git add .sops.yaml secrets/
git commit -m "Rotate age key"
```

---

## ğŸ›¡ï¸ SÃ©curitÃ© et bonnes pratiques

### âœ… Ã€ FAIRE

1. **Sauvegarde ta clÃ© age Ã  plusieurs endroits diffÃ©rents**
   - Password manager
   - USB chiffrÃ©e
   - Papier dans un coffre
   - Cloud chiffrÃ©

2. **VÃ©rifie les permissions des fichiers**
   ```bash
   chmod 600 ~/.age/key.txt
   chmod 600 ~/.ssh/id_*
   chmod 644 ~/.ssh/*.pub
   chmod 600 ~/.ssh/config
   ```

3. **Ne commit que les fichiers chiffrÃ©s**
   - âœ… `secrets/*.sops.yaml` (clÃ©s + config chiffrÃ©s)
   - âœ… `.sops.yaml`
   - âŒ `~/.age/key.txt`
   - âŒ `~/.ssh/id_*`
   - âŒ `~/.ssh/config`

4. **Teste rÃ©guliÃ¨rement le dÃ©chiffrement**
   ```bash
   sops --decrypt secrets/ssh-keys.sops.yaml
   ```

5. **Documente tes clÃ©s**
   - Quel service utilise quelle clÃ©
   - Date de crÃ©ation
   - Date d'expiration si applicable

### âŒ Ã€ NE JAMAIS FAIRE

1. âŒ Commiter `~/.age/key.txt` dans Git
2. âŒ Commiter des clÃ©s SSH en clair
3. âŒ Partager ta clÃ© age par email/Slack
4. âŒ Stocker ta clÃ© age sur Dropbox/Drive en clair
5. âŒ Oublier de sauvegarder ta clÃ© age
6. âŒ Utiliser la mÃªme clÃ© SSH partout
7. âŒ Ignorer les permissions des fichiers

### ğŸ”’ Checklist de sÃ©curitÃ©

Avant de commit :
```bash
# VÃ©rifie qu'aucun secret en clair n'est trackÃ©
git status

# VÃ©rifie le contenu du commit
git diff --cached

# VÃ©rifie que .gitignore est correct
cat .gitignore

# Scanne les secrets (optionnel)
git secrets --scan
```

---

## ğŸ†˜ DÃ©pannage

### Erreur : "no age identity found"

**ProblÃ¨me :** SOPS ne trouve pas ta clÃ© age

**Solution :**
```bash
# VÃ©rifie que la clÃ© existe
ls -la ~/.age/key.txt

# VÃ©rifie les permissions
chmod 600 ~/.age/key.txt

# Teste le dÃ©chiffrement
sops --decrypt secrets/ssh-keys.sops.yaml
```

### Erreur : "MAC mismatch"

**ProblÃ¨me :** Le fichier a Ã©tÃ© modifiÃ© ou corrompu

**Solution :**
```bash
# RÃ©cupÃ¨re depuis Git
git checkout secrets/ssh-keys.sops.yaml

# Ou depuis un backup
cp backup/ssh-keys.sops.yaml secrets/
```

### Erreur : "failed to get the data key"

**ProblÃ¨me :** Ta clÃ© age ne correspond pas Ã  celle utilisÃ©e pour chiffrer

**Solution :**
```bash
# VÃ©rifie ta clÃ© publique
age-keygen -y ~/.age/key.txt

# Compare avec .sops.yaml
cat .sops.yaml

# Si diffÃ©rent, restaure la bonne clÃ© age
```

### J'ai perdu ma clÃ© age !

**Malheureusement, c'est GAME OVER.** ğŸ˜¢

Sans la clÃ© age, impossible de dÃ©chiffrer tes secrets.

**Solutions :**
1. Restaure depuis un backup (USB, password manager)
2. Si vraiment perdue :
   - GÃ©nÃ¨re de nouvelles clÃ©s SSH
   - GÃ©nÃ¨re une nouvelle clÃ© age
   - Rechiffre tout avec la nouvelle clÃ©
   - Update partout (GitHub, GitLab, serveurs)

**PrÃ©vention :**
- Sauvegarde ta clÃ© Ã  **3+ endroits diffÃ©rents**
- Teste rÃ©guliÃ¨rement tes backups

### Fichier YAML mal formatÃ©

**ProblÃ¨me :** Erreur lors du chiffrement/dÃ©chiffrement

**Solution :**
```bash
# VÃ©rifie la syntaxe YAML
yq eval /tmp/ssh-keys.yaml

# Valide le fichier SOPS
sops --decrypt secrets/ssh-keys.sops.yaml | yq eval
```

### Le SSH config est-il chiffrÃ© ?

**Oui ! Le fichier `~/.ssh/config` est inclus dans `secrets/ssh-keys.sops.yaml`.**

**Pourquoi chiffrer le SSH config ?**
- Contient des hostnames internes
- Contient des adresses IP privÃ©es
- Contient des noms d'utilisateurs
- Contient les chemins vers les clÃ©s SSH

**Structure dans le fichier SOPS :**
```yaml
ssh:
  github:
    private_key: ...
    public_key: ...
  
  gitlab:
    private_key: ...
    public_key: ...

ssh_config: |
  Host github.com
    HostName github.com
    User git
    ...
```

**DÃ©chiffrement :**
```bash
# Extraire juste le config
sops --decrypt secrets/ssh-keys.sops.yaml | yq '.ssh_config' > ~/.ssh/config
chmod 600 ~/.ssh/config
```

---

## ğŸ“š Ressources supplÃ©mentaires

### Documentation officielle

- [age - GitHub](https://github.com/FiloSottile/age)
- [SOPS - GitHub](https://github.com/getsops/sops)
- [yq - GitHub](https://github.com/mikefarah/yq)

### Tutoriels

- [age Tutorial](https://github.com/FiloSottile/age#tutorial)
- [SOPS with age](https://github.com/getsops/sops#encrypting-using-age)

### Alternatives

- **GPG** : Plus complexe, mais standard historique
- **Vault (HashiCorp)** : Pour les environnements enterprise
- **sealed-secrets** : Pour Kubernetes
- **git-crypt** : Chiffrement transparent dans Git

---

## ğŸ“„ RÃ©capitulatif

### Structure finale

```
projet/
â”œâ”€â”€ Taskfile.yaml
â”œâ”€â”€ .sops.yaml                    # Config SOPS (commit âœ…)
â”œâ”€â”€ secrets/
â”‚   â””â”€â”€ ssh-keys.sops.yaml       # ClÃ©s chiffrÃ©es (commit âœ…)
â”œâ”€â”€ .gitignore                    # Protection (commit âœ…)
â””â”€â”€ README-SECRETS.md             # Ce guide (commit âœ…)

~/.config/sops/age/
â””â”€â”€ keys.txt                      # ClÃ© age (NE PAS COMMIT âŒ)

~/.ssh/
â”œâ”€â”€ gitlab                        # ClÃ©s en clair (NE PAS COMMIT âŒ)
â”œâ”€â”€ gitlab.pub
â”œâ”€â”€ seedbox
â”œâ”€â”€ seedbox.pub
â””â”€â”€ config
```

### Workflow rÃ©sumÃ©

**Setup initial :**
```bash
brew install age sops yq
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt
# SAUVEGARDE LA CLÃ‰ !
cat > .sops.yaml << EOF
creation_rules:
  - age: $(age-keygen -y ~/.config/sops/age/keys.txt)
EOF
# Chiffrer les secrets depuis le rÃ©pertoire du projet
cd ~/mon-projet
mkdir -p secrets
cat > secrets/ssh-keys.yaml << 'EOF'
...
EOF
sops --encrypt secrets/ssh-keys.yaml > secrets/ssh-keys.sops.yaml
rm secrets/ssh-keys.yaml
git add .sops.yaml secrets/ .gitignore
git push
```

**Nouvelle machine :**
```bash
git clone <repo>
cd <repo>
mkdir -p ~/.config/sops/age
cp /backup/sops-age-key.txt ~/.config/sops/age/keys.txt
chmod 600 ~/.config/sops/age/keys.txt
task  # ou dÃ©chiffrer manuellement
```

---

## ğŸ‰ Conclusion

Tu as maintenant un systÃ¨me professionnel et sÃ©curisÃ© pour gÃ©rer tes clÃ©s SSH :

âœ… Chiffrement fort avec age
âœ… VersionnÃ© dans Git (sÃ©curisÃ©)
âœ… DÃ©chiffrement automatique
âœ… Support de plusieurs clÃ©s
âœ… Portable sur toutes les machines
âœ… Ã‰dition facile avec SOPS

**N'oublie JAMAIS de sauvegarder ta clÃ© age !** ğŸ”

---

**Questions ou problÃ¨mes ?** Consulte la section [DÃ©pannage](#dÃ©pannage) ou ouvre une issue sur le repo.