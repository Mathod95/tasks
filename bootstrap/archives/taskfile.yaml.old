version: '3'

silent: true

vars:
  BREW: /home/linuxbrew/.linuxbrew/bin/brew
  SOPS: /home/linuxbrew/.linuxbrew/bin/sops
  YQ: /home/linuxbrew/.linuxbrew/bin/yq

tasks:
  # ==========================================
  # Point d'entrÃ©e principal
  # ==========================================
  
  default:
    desc: "Bootstrap complet de l'environnement (auto-lock des secrets)"
    cmds:
      - task: bootstrap

  bootstrap:
    desc: "Installation et configuration complÃ¨te"
    aliases: [setup, init]
    cmds:
      - task: age:deploy
      - task: sudo:check
      - task: secrets:unlock
      - defer: task secrets:lock
      - task: brew:install
      - task: packages:install
      - task: ssh:setup
      - task: git:config
      - task: git:known-hosts
      - task: git:clone
      - task: vscode:setup
      - task: wsl:configure
      - task: zsh:setup
      - task: zellij:setup
      - echo ""
      - echo "âœ… Bootstrap terminÃ© !"
      - echo "ğŸ”’ Secrets automatiquement verrouillÃ©s"

  # ==========================================
  # Gestion de la clÃ© age
  # ==========================================

  age:deploy:
    desc: "ğŸ“¦ DÃ©ploie la clÃ© age chiffrÃ©e depuis le repo"
    cmds:
      - |
        if [ ! -f secrets/age-key.txt.age ]; then
          echo "âŒ Fichier secrets/age-key.txt.age introuvable !"
          echo "ğŸ’¡ Assure-toi que le fichier est bien dans le repo"
          exit 1
        fi
      - mkdir -p secrets
      - |
        if [ -f secrets/age-key.txt.age ]; then
          echo "âœ… ClÃ© age chiffrÃ©e trouvÃ©e dans le repo"
        else
          echo "âŒ ClÃ© age chiffrÃ©e introuvable"
          exit 1
        fi
    status:
      - test -f secrets/age-key.txt.age

  # ==========================================
  # Gestion des secrets avec age + passphrase
  # ==========================================

  secrets:unlock:
    desc: "ğŸ”“ DÃ©chiffre la clÃ© age avec ta passphrase"
    cmds:
      - |
        if [ ! -f ~/.config/sops/age/keys.txt ]; then
          echo "ğŸ”‘ DÃ©chiffrement de la clÃ© age..."
          mkdir -p ~/.config/sops/age
          age --decrypt secrets/age-key.txt.age > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt
          echo "âœ… ClÃ© age dÃ©chiffrÃ©e"
        else
          echo "â­ï¸  ClÃ© age dÃ©jÃ  dÃ©chiffrÃ©e"
        fi
    status:
      - test -f ~/.config/sops/age/keys.txt

  secrets:lock:
    desc: "ğŸ”’ Supprime la clÃ© age dÃ©chiffrÃ©e (sÃ©curitÃ©)"
    cmds:
      - |
        if [ -f ~/.config/sops/age/keys.txt ]; then
          rm -f ~/.config/sops/age/keys.txt
          echo "ğŸ”’ Secrets verrouillÃ©s"
        else
          echo "â­ï¸  Secrets dÃ©jÃ  verrouillÃ©s"
        fi

  secrets:status:
    desc: "ğŸ“Š VÃ©rifie si les secrets sont dÃ©verrouillÃ©s"
    cmds:
      - |
        if [ -f ~/.config/sops/age/keys.txt ]; then
          echo "ğŸ”“ Secrets dÃ©verrouillÃ©s"
          echo "ğŸ’¡ Utilise 'task secrets:lock' pour verrouiller"
        else
          echo "ğŸ”’ Secrets verrouillÃ©s"
          echo "ğŸ’¡ Utilise 'task secrets:unlock' pour dÃ©verrouiller"
        fi

  work:
    desc: "ğŸ”“ DÃ©verrouille les secrets pour travailler (sans auto-lock)"
    cmds:
      - task: secrets:unlock
      - echo ""
      - echo "âœ… Secrets dÃ©verrouillÃ©s pour travailler"
      - echo "ğŸ’¡ Tu peux maintenant utiliser SOPS :"
      - echo "   - sops secrets/ssh-keys.sops.yaml"
      - echo "   - sops --decrypt secrets/ssh-keys.sops.yaml"
      - echo ""
      - echo "âš ï¸  N'oublie pas de verrouiller quand tu as fini :"
      - echo "   - task secrets:lock"

  # ==========================================
  # SSH - DÃ©chiffrement et configuration
  # ==========================================

  ssh:setup:
    desc: "ğŸ”‘ Configure SSH en dÃ©chiffrant les clÃ©s"
    cmds:
      - task: ssh:decrypt
      - task: ssh:configure
      - echo "âœ… SSH configurÃ©"

  ssh:decrypt:
    desc: "DÃ©chiffre les clÃ©s SSH depuis SOPS"
    internal: true
    preconditions:
      - sh: test -f ~/.config/sops/age/keys.txt
        msg: "âŒ ClÃ© age non dÃ©chiffrÃ©e ! Lance 'task secrets:unlock' d'abord"
    cmds:
      - mkdir -p ~/.ssh
      - chmod 700 ~/.ssh
      - |
        # GitLab
        echo "ğŸ”“ DÃ©chiffrement clÃ© GitLab..."
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} '.ssh.gitlab.private_key' > ~/.ssh/gitlab
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} -r '.ssh.gitlab.public_key' > ~/.ssh/gitlab.pub
        chmod 600 ~/.ssh/gitlab
        chmod 644 ~/.ssh/gitlab.pub
        echo "âœ… ClÃ© GitLab restaurÃ©e"
      - |
        # GitHub
        echo "ğŸ”“ DÃ©chiffrement clÃ© GitHub..."
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} '.ssh.github.private_key' > ~/.ssh/github
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} -r '.ssh.github.public_key' > ~/.ssh/github.pub
        chmod 600 ~/.ssh/github
        chmod 644 ~/.ssh/github.pub
        echo "âœ… ClÃ© GitHub restaurÃ©e"
      - |
        # Seedbox
        echo "ğŸ”“ DÃ©chiffrement clÃ© Seedbox..."
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} '.ssh.seedbox.private_key' > ~/.ssh/seedbox
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} -r '.ssh.seedbox.public_key' > ~/.ssh/seedbox.pub
        chmod 600 ~/.ssh/seedbox
        chmod 644 ~/.ssh/seedbox.pub
        echo "âœ… ClÃ© Seedbox restaurÃ©e"
      - |
        # SSH config
        echo "ğŸ”“ DÃ©chiffrement SSH config..."
        {{.SOPS}} --decrypt secrets/ssh-keys.sops.yaml | {{.YQ}} '.ssh_config' > ~/.ssh/config
        chmod 600 ~/.ssh/config
        echo "âœ… SSH config restaurÃ©"

  ssh:configure:
    desc: "Configure l'agent SSH"
    internal: true
    cmds:
      - |
        # DÃ©marrer l'agent SSH si pas dÃ©jÃ  lancÃ©
        if [ -z "$SSH_AUTH_SOCK" ]; then
          eval $(ssh-agent -s)
        fi
        echo "âœ… Agent SSH configurÃ©"

  ssh:test:
    desc: "ğŸ§ª Teste les connexions SSH"
    cmds:
      - echo "ğŸ§ª Test de connexion GitLab..."
      - ssh -T git@gitlab.com || true
      - echo ""
      - echo "ğŸ§ª Test de connexion Seedbox..."
      - ssh -o ConnectTimeout=5 seedbox echo "âœ… Connexion seedbox OK" || echo "âš ï¸  Connexion seedbox Ã©chouÃ©e"

  # ==========================================
  # Git - Configuration et repositories
  # ==========================================

  git:config:
    desc: "Configure Git global (user.name et user.email)"
    internal: true
    cmds:
      - git config --global user.email "felix.mathias95@gmail.com"
      - git config --global user.name "Mathod"
      - echo "âœ… Configuration Git appliquÃ©e"
    status:
      - test "$(git config --global user.email)" = "felix.mathias95@gmail.com"
      - test "$(git config --global user.name)" = "Mathod"

  git:known-hosts:
    desc: "Ajoute GitHub et GitLab aux known_hosts"
    internal: true
    cmds:
      - |
        echo "ğŸ”‘ Ajout des serveurs Git aux known_hosts..."
        mkdir -p ~/.ssh
        ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
        ssh-keyscan gitlab.com >> ~/.ssh/known_hosts 2>/dev/null
        echo "âœ… Known hosts configurÃ©s"

  git:clone:
    desc: "Clone les dÃ©pÃ´ts GitHub (si pas dÃ©jÃ  prÃ©sents)"
    internal: true
    vars:
      REPOS:
        - git@github.com:Mathod95/wsl.git
        - git@github.com:Mathod95/task.git
        - git@github.com:Mathod95/docs.git
    cmds:
      - mkdir -p ~/github
      - |
        repos=({{.REPOS | join " "}})
        for repo in "${repos[@]}"; do
          repo_name=$(basename "$repo" .git)
          if [ -d "$HOME/github/$repo_name" ]; then
            echo "â­ï¸  $repo_name dÃ©jÃ  clonÃ©"
          else
            echo "ğŸ“¥ Clonage de $repo_name..."
            git clone "$repo" "$HOME/github/$repo_name"
          fi
        done
      - echo "âœ… DÃ©pÃ´ts GitHub synchronisÃ©s"

  git:pull:
    desc: "ğŸ”„ Met Ã  jour les dÃ©pÃ´ts GitHub locaux"
    vars:
      REPOS:
        - wsl
        - task
        - docs
    cmds:
      - |
        echo "ğŸ”„ Mise Ã  jour des dÃ©pÃ´ts GitHub..."
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        repos=({{.REPOS | join " "}})
        for repo_name in "${repos[@]}"; do
          if [ -d "$HOME/github/$repo_name" ]; then
            cd "$HOME/github/$repo_name"
            
            # VÃ©rifier s'il y a des modifications locales
            if git diff-index --quiet HEAD --; then
              echo "ğŸ“¥ Pull $repo_name..."
              git pull
            else
              echo "âš ï¸  $repo_name a des modifications locales, skip"
            fi
          else
            echo "âŒ $repo_name n'existe pas, lance 'task git:clone' d'abord"
          fi
        done
        
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        echo "âœ… Mise Ã  jour terminÃ©e"

  # ==========================================
  # VS Code - Configuration et extensions
  # ==========================================

  vscode:setup:
    desc: "ğŸ¨ Configure VS Code (symlinks + extensions)"
    cmds:
      - task: vscode:code-symlink
      - task: vscode:symlinks
      - task: vscode:extensions

  vscode:symlinks:
    desc: "CrÃ©e les symlinks helm/kubectl pour VS Code Kubernetes"
    internal: true
    cmds:
      - mkdir -p ~/.local/state/vs-kubernetes/tools/helm/linux-amd64
      - mkdir -p ~/.local/state/vs-kubernetes/tools/kubectl
      - |
        echo "ğŸ”— CrÃ©ation symlinks helm/kubectl..."
        ln -sf /home/linuxbrew/.linuxbrew/bin/helm ~/.local/state/vs-kubernetes/tools/helm/linux-amd64/helm
        ln -sf /home/linuxbrew/.linuxbrew/bin/kubectl ~/.local/state/vs-kubernetes/tools/kubectl/kubectl
        echo "âœ… Symlinks crÃ©Ã©s"

  vscode:extensions:
    desc: "Installe les extensions VS Code"
    internal: true
    vars:
      EXTENSIONS:
        - ms-kubernetes-tools.vscode-kubernetes-tools
        - ms-kubernetes-tools.kind-vscode
        - ms-azuretools.vscode-docker
        - task.vscode-task
        - upboundio.upbound
        - redhat.vscode-yaml
    cmds:
      - |
        echo "ğŸ“¦ Installation des extensions VS Code..."
        
        # Initialiser VS Code Server
        echo "ğŸ”§ Initialisation VS Code Server..."
        code --version > /dev/null 2>&1 || true
        sleep 2
        
        # Installer les extensions
        extensions=({{.EXTENSIONS | join " "}})
        for ext in "${extensions[@]}"; do
          echo "  ğŸ“¥ Installation $ext..."
          code --install-extension "$ext" --force || echo "  âš ï¸  Ã‰chec $ext"
        done
        
        echo "âœ… Extensions installÃ©es"

  vscode:code-symlink:
    desc: "CrÃ©e le symlink global pour la commande code"
    internal: true
    cmds:
      - |
        VSCODE_PATH="/mnt/c/Users/$USER/AppData/Local/Programs/Microsoft VS Code/bin/code"
        
        if [ -f "$VSCODE_PATH" ]; then
          echo "ğŸ”— CrÃ©ation symlink global 'code'..."
          sudo ln -sf "$VSCODE_PATH" /usr/local/bin/code
          echo "âœ… Commande 'code' disponible globalement"
        else
          echo "âš ï¸  VS Code non trouvÃ© Ã  $VSCODE_PATH"
          echo "ğŸ’¡ VS Code doit Ãªtre installÃ© sur Windows"
        fi

  # ==========================================
  # WSL - Configuration
  # ==========================================

  wsl:configure:
    desc: "âš™ï¸ Configure WSL (systemd)"
    cmds:
      - |
        echo "âš™ï¸ Configuration de WSL..."
        
        # VÃ©rifier si systemd est dÃ©jÃ  activÃ©
        if grep -q "^\[boot\]" /etc/wsl.conf 2>/dev/null && grep -q "^systemd.*=.*true" /etc/wsl.conf 2>/dev/null; then
          echo "â­ï¸  systemd dÃ©jÃ  activÃ© dans /etc/wsl.conf"
        else
          echo "ğŸ“ Activation de systemd dans /etc/wsl.conf..."
          
          # CrÃ©er ou mettre Ã  jour /etc/wsl.conf
          printf "\n[boot]\nsystemd = true\n" | sudo tee -a /etc/wsl.conf > /dev/null
          
          echo "âœ… systemd activÃ©"
          echo ""
          echo "âš ï¸  IMPORTANT : RedÃ©marrer WSL pour appliquer les changements !"
          echo "   Windows PowerShell : wsl --shutdown"
          echo "   Puis relancer WSL"
        fi

  # ==========================================
  # ZSH - Configuration
  # ==========================================

  zsh:setup:
    desc: "ğŸš Configure ZSH"
    cmds:
      - task: zsh:histfile
      - task: zsh:add-to-shells
      - task: zsh:config
      - task: zsh:abbr
      - task: zsh:plugins
      - task: zsh:set-default

  zsh:histfile:
    desc: "CrÃ©e le fichier d'historique ZSH"
    internal: true
    cmds:
      - |
        if [ ! -f ~/.histfile ]; then
          echo "ğŸ“ CrÃ©ation de ~/.histfile..."
          touch ~/.histfile
          chmod 600 ~/.histfile
          echo "âœ… Fichier d'historique ZSH crÃ©Ã©"
        else
          echo "â­ï¸  ~/.histfile existe dÃ©jÃ "
        fi

  zsh:add-to-shells:
    desc: "Ajoute ZSH Ã  la liste des shells valides"
    internal: true
    cmds:
      - |
        ZSH_PATH="/home/linuxbrew/.linuxbrew/bin/zsh"
        
        if grep -q "^$ZSH_PATH$" /etc/shells 2>/dev/null; then
          echo "â­ï¸  ZSH dÃ©jÃ  dans /etc/shells"
        else
          echo "ğŸ“ Ajout de ZSH Ã  /etc/shells..."
          echo "$ZSH_PATH" | sudo tee -a /etc/shells > /dev/null
          echo "âœ… ZSH ajoutÃ© Ã  /etc/shells"
        fi

  zsh:config:
    desc: "Copie la configuration ZSH"
    internal: true
    cmds:
      - |
        echo "ğŸ“ Copie de la configuration ZSH..."
        
        if [ -f configs/.zshrc ]; then
          cp configs/.zshrc ~/.zshrc
          echo "âœ… .zshrc copiÃ©"
        else
          echo "âš ï¸  configs/.zshrc introuvable"
        fi
        
        if [ -f configs/.p10k.zsh ]; then
          cp configs/.p10k.zsh ~/.p10k.zsh
          echo "âœ… .p10k.zsh copiÃ©"
        fi

  zsh:abbr:
    desc: "Copie les abbreviations ZSH"
    internal: true
    cmds:
      - |
        if [ -f configs/user-abbreviations ]; then
          echo "ğŸ“ Copie des abbreviations..."
          mkdir -p ~/.config/zsh-abbr
          cp configs/user-abbreviations ~/.config/zsh-abbr/user-abbreviations
          chmod 600 ~/.config/zsh-abbr/user-abbreviations
          echo "âœ… Abbreviations copiÃ©es"
        else
          echo "â­ï¸  configs/user-abbreviations introuvable (optionnel)"
        fi

  zsh:plugins:
    desc: "Installe les plugins Zinit"
    internal: true
    cmds:
      - |
        echo "ğŸ“¦ Installation des plugins Zinit..."
        echo "â³ Cela peut prendre 10-30 secondes..."
        echo ""
        
        # Lancer ZSH en mode non-interactif pour que Zinit installe les plugins
        /home/linuxbrew/.linuxbrew/bin/zsh -c "source ~/.zshrc && exit" 2>&1 | grep -E "(Cloning|Compiling|Downloaded)" || true
        
        echo ""
        echo "âœ… Plugins Zinit installÃ©s"

  zsh:set-default:
    desc: "DÃ©finit ZSH comme shell par dÃ©faut"
    internal: true
    cmds:
      - |
        ZSH_PATH="/home/linuxbrew/.linuxbrew/bin/zsh"
        current_shell=$(getent passwd $USER | cut -d: -f7)
        
        if [ "$current_shell" = "$ZSH_PATH" ]; then
          echo "â­ï¸  ZSH dÃ©jÃ  shell par dÃ©faut"
        else
          echo "ğŸš Changement du shell par dÃ©faut vers ZSH..."
          sudo chsh -s "$ZSH_PATH" "$USER"
          echo "âœ… ZSH dÃ©fini comme shell par dÃ©faut"
          echo ""
          echo "âš ï¸  IMPORTANT : RedÃ©marrer le terminal pour appliquer !"
        fi

  # ==========================================
  # Zellij - Configuration
  # ==========================================

  zellij:setup:
    desc: "ğŸ–¥ï¸ Configure Zellij"
    cmds:
      - task: zellij:config

  zellij:config:
    desc: "Copie la configuration Zellij"
    internal: true
    cmds:
      - |
        echo "ğŸ“ Copie de la configuration Zellij..."
        
        # CrÃ©er les dossiers
        mkdir -p ~/.config/zellij/themes
        
        # Copier config.kdl
        if [ -f configs/config.kdl ]; then
          cp configs/config.kdl ~/.config/zellij/config.kdl
          chmod 644 ~/.config/zellij/config.kdl
          echo "âœ… config.kdl copiÃ©"
        else
          echo "âš ï¸  configs/config.kdl introuvable"
        fi
        
        # Copier dracula.kdl
        if [ -f configs/dracula.kdl ]; then
          cp configs/dracula.kdl ~/.config/zellij/themes/dracula.kdl
          chmod 644 ~/.config/zellij/themes/dracula.kdl
          echo "âœ… dracula.kdl copiÃ©"
        else
          echo "â­ï¸  configs/dracula.kdl introuvable (optionnel)"
        fi

  # ==========================================
  # Sudo - Demande le mot de passe une fois
  # ==========================================

  sudo:check:
    desc: "Demande le mot de passe sudo (une seule fois)"
    internal: true
    cmds:
      - sudo -v
      - echo "âœ… AccÃ¨s sudo accordÃ©"

  # ==========================================
  # Brew - Gestion Homebrew
  # ==========================================

  brew:install:
    desc: "ğŸ“¦ Installe Homebrew si nÃ©cessaire"
    cmds:
      - task: brew:install:deps
      - task: brew:install:binary
      - task: brew:configure:path
      - task: brew:analytics:off
    status:
      - command -v brew

  brew:install:deps:
    desc: "Installe les dÃ©pendances Homebrew"
    internal: true
    cmds:
      - sudo apt-get update
      - sudo apt-get install -y build-essential procps curl file git
      - echo "âœ… DÃ©pendances Homebrew installÃ©es"
    status:
      - dpkg -s build-essential

  brew:install:binary:
    desc: "Installe Homebrew"
    internal: true
    run: once
    cmds:
      - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - echo "âœ… Homebrew installÃ©"
    status:
      - test -d /home/linuxbrew/.linuxbrew

  brew:configure:path:
    desc: "Configure Homebrew dans le PATH"
    internal: true
    cmds:
      - |
        if ! grep -q "linuxbrew" ~/.bashrc; then
          echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
          echo "âœ… Homebrew ajoutÃ© Ã  ~/.bashrc"
        else
          echo "â­ï¸  Homebrew dÃ©jÃ  configurÃ© dans ~/.bashrc"
        fi
    status:
      - grep -q "linuxbrew" ~/.bashrc

  brew:analytics:off:
    desc: "DÃ©sactive la tÃ©lÃ©mÃ©trie Homebrew"
    internal: true
    run: once
    cmds:
      - '{{.BREW}} analytics off'
      - echo "âœ… TÃ©lÃ©mÃ©trie Homebrew dÃ©sactivÃ©e"

  brew:update:
    desc: "ğŸ”„ Met Ã  jour les dÃ©pÃ´ts Homebrew"
    cmds:
      - '{{.BREW}} update'
      - echo "âœ… DÃ©pÃ´ts Homebrew mis Ã  jour"

  brew:upgrade:
    desc: "â¬†ï¸  Upgrade tous les packages Homebrew"
    cmds:
      - '{{.BREW}} upgrade'
      - echo "âœ… Packages Homebrew upgradÃ©s"

  brew:list:
    desc: "ğŸ“‹ Liste tous les packages installÃ©s"
    cmds:
      - '{{.BREW}} list --versions'

  brew:list:leaves:
    desc: "ğŸ“‹ Liste les packages installÃ©s manuellement"
    cmds:
      - '{{.BREW}} leaves --versions'

  brew:list:pretty:
    desc: "ğŸ“‹ Liste les packages avec affichage stylÃ©"
    cmds:
      - |
        echo "ğŸ“¦ Packages Homebrew installÃ©s :"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        {{.BREW}} leaves | while read package; do
          version=$({{.BREW}} list --versions "$package" | awk '{print $2}')
          case $package in
            age)       emoji="ğŸ”" ;;
            argocd)    emoji="ğŸš€" ;;
            bat)       emoji="ğŸ¦‡" ;;
            eza)       emoji="ğŸ“‚" ;;
            git)       emoji="ğŸŒ¿" ;;
            helm)      emoji="âˆ" ;;
            kind)      emoji="ğŸ³" ;;
            kubectl)   emoji="â˜¸ï¸" ;;
            kubecolor) emoji="ğŸ¨" ;;
            kubectx)   emoji="ğŸ”„" ;;
            sops)      emoji="ğŸ”’" ;;
            vim)       emoji="âœï¸" ;;
            yq)        emoji="ğŸ“" ;;
            zsh)       emoji="ğŸš" ;;
            zellij)    emoji="ğŸ–¥ï¸" ;;
            *)         emoji="ğŸ“¦" ;;
          esac
          printf "%s %-15s %s\n" "$emoji" "$package" "$version"
        done

  # ==========================================
  # Packages - Installation des outils
  # ==========================================

  packages:install:
    desc: "Installe les packages essentiels"
    internal: true
    vars:
      PACKAGES:
        - age
        # - ansible
        - argocd
        - argocd-autopilot
        # - asciinema
        # - awscli
        - bat
        - btop
        # - cilium-cli
        # - cloud-provider-kind
        # - crossplane
        - curl
        # - docker
        - eza
        - fastfetch
        - fd
        - fzf
        - git
        - helm
        # - k9s
        # - keychain
        - kind
        # - kube-linter
        # - kube-score
        - kubecolor
        - kubectl
        # - kubescape
        - kubectx
        # - krew
        - kustomize
        - kyverno
        # - neovim
        # - opentofu
        - ripgrep
        - sops
        - systemd
        # - velero
        - vim
        - wget
        - yq
        - zellij
        - zinit
        - zsh
    cmds:
      - echo "ğŸ“¦ Installation des packages..."
      - |
        packages="{{.PACKAGES | join " "}}"
        {{.BREW}} install $packages
      - echo "âœ… Packages installÃ©s"
    status:
      - |
        packages="{{.PACKAGES | join " "}}"
        for pkg in $packages; do
          if ! {{.BREW}} list "$pkg" >/dev/null 2>&1; then
            exit 1
          fi
        done
        exit 0

  # ==========================================
  # Utilitaires
  # ==========================================

  versions:
    desc: "ğŸ“Š Affiche les versions de tous les packages"
    cmds:
      - |
        echo "ğŸ“¦ Versions des packages :"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        
        # DÃ©finir les packages avec leurs emojis
        declare -A packages=(
          ["age"]="ğŸ”"
          ["ansible"]="ğŸ§ª"
          ["argocd"]="ğŸš€"
          ["argocd-autopilot"]="ğŸ¤–"
          ["asciinema"]="ğŸ“¹"
          ["awscli"]="â˜ï¸"
          ["bat"]="ğŸ¦‡"
          ["btop"]="ğŸ“Š"
          ["cilium-cli"]="ğŸ§¬"
          ["cloud-provider-kind"]="â˜ï¸"
          ["crossplane"]="ğŸ› ï¸"
          ["curl"]="ğŸŒŠ"
          ["docker"]="ğŸ³"
          ["eza"]="ğŸ“‚"
          ["fastfetch"]="âš¡"
          ["fd"]="ğŸ”"
          ["fzf"]="ğŸ”"
          ["git"]="ğŸŒ¿"
          ["helm"]="âˆ"
          ["k9s"]="ğŸ–¥ï¸"
          ["keychain"]="ğŸ”"
          ["kind"]="ğŸ³"
          ["kube-linter"]="ğŸ”"
          ["kube-score"]="ğŸ“Š"
          ["kubecolor"]="ğŸ¨"
          ["kubectl"]="â˜¸ï¸"
          ["kubescape"]="ğŸ›¡ï¸"
          ["kubectx"]="ğŸ”„"
          ["krew"]="ğŸ§©"
          ["kustomize"]="ğŸ”§"
          ["kyverno"]="ğŸ›¡ï¸"
          ["neovim"]="âœ¨"
          ["opentofu"]="ğŸŒ"
          ["ripgrep"]="ğŸ”"
          ["sops"]="ğŸ”’"
          ["systemd"]="âš™ï¸"
          ["velero"]="ğŸ›Ÿ"
          ["vim"]="âœï¸"
          ["wget"]="ğŸ“¥"
          ["yq"]="ğŸ“"
          ["zellij"]="ğŸ–¥ï¸"
          ["zinit"]="âš¡"
          ["zsh"]="ğŸš"
        )
        
        # Liste de tous les packages (dans l'ordre)
        all_packages=(
          age ansible argocd argocd-autopilot asciinema awscli
          bat btop cilium-cli cloud-provider-kind crossplane curl
          docker eza fastfetch fd fzf git helm k9s keychain kind
          kube-linter kube-score kubecolor kubectl kubescape kubectx
          krew kustomize kyverno neovim opentofu ripgrep sops
          systemd velero vim wget yq zellij zinit zsh
        )
        
        for pkg in "${all_packages[@]}"; do
          emoji="${packages[$pkg]:-ğŸ“¦}"
          version=$({{.BREW}} list --versions "$pkg" 2>/dev/null | awk '{print $2}')
          
          if [ -z "$version" ]; then
            printf "%s %-20s : âŒ non installÃ©\n" "$emoji" "$pkg"
          else
            printf "%s %-20s : %s\n" "$emoji" "$pkg" "$version"
          fi
        done
        
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

  clean:
    desc: "ğŸ§¹ Nettoie les fichiers temporaires"
    cmds:
      - task: secrets:lock
      - echo "âœ… Nettoyage terminÃ©"

  status:
    desc: "ğŸ“Š Affiche le statut de l'environnement"
    cmds:
      - echo "ğŸ“Š Statut de l'environnement"
      - echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      - echo ""
      - echo "ğŸº Homebrew :"
      - |
        if command -v brew >/dev/null 2>&1; then
          echo "  âœ… InstallÃ© ($({{.BREW}} --version | head -1))"
        else
          echo "  âŒ Non installÃ©"
        fi
      - echo ""
      - echo "ğŸ” Secrets :"
      - |
        if [ -f ~/.config/sops/age/keys.txt ]; then
          echo "  ğŸ”“ DÃ©verrouillÃ©s"
        else
          echo "  ğŸ”’ VerrouillÃ©s"
        fi
      - echo ""
      - echo "ğŸ”‘ SSH :"
      - |
        if [ -f ~/.ssh/gitlab ] && [ -f ~/.ssh/seedbox ]; then
          echo "  âœ… ClÃ©s prÃ©sentes (gitlab, seedbox)"
        else
          echo "  âš ï¸  ClÃ©s manquantes"
        fi
      - echo ""
      - echo "ğŸ“¦ Packages :"
      - |
        count=$({{.BREW}} list 2>/dev/null | wc -l)
        echo "  ğŸ“¦ $count packages installÃ©s"

  help:
    desc: "â“ Affiche l'aide"
    cmds:
      - echo "ğŸš€ Taskfile Bootstrap - Commandes disponibles"
      - echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      - echo ""
      - echo "ğŸ¯ Principales :"
      - echo "  task                    Bootstrap complet (auto-lock)"
      - echo "  task work               DÃ©verrouille pour travailler"
      - echo "  task status             Affiche le statut"
      - echo ""
      - echo "ğŸ” Gestion des secrets :"
      - echo "  task secrets:unlock     DÃ©verrouille les secrets"
      - echo "  task secrets:lock       Verrouille les secrets"
      - echo "  task secrets:status     Statut des secrets"
      - echo ""
      - echo "ğŸ”‘ SSH :"
      - echo "  task ssh:setup          Configure SSH"
      - echo "  task ssh:test           Teste les connexions"
      - echo ""
      - echo "ğŸº Homebrew :"
      - echo "  task brew:update        Met Ã  jour les dÃ©pÃ´ts"
      - echo "  task brew:upgrade       Upgrade les packages"
      - echo "  task brew:list:pretty   Liste les packages"
      - echo ""
      - echo "Astuce - Lance task --list pour voir toutes les commandes"